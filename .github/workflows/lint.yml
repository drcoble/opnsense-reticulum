name: Lint

on:
  pull_request:
    branches: [development, testing, main]

jobs:
  php:
    name: PHP Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install PHP CLI
        run: sudo apt-get install -y -q php-cli
      - name: Check PHP syntax
        run: |
          errors=0
          while IFS= read -r -d '' f; do
            php -l "$f" >/dev/null 2>&1 || { echo "FAIL: $f"; errors=$((errors+1)); }
          done < <(find net/reticulum/src -name "*.php" -print0)
          [ "$errors" -eq 0 ] || { echo "$errors file(s) failed PHP syntax check"; exit 1; }
          echo "PHP syntax OK"

  xml:
    name: XML Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install xmllint
        run: sudo apt-get install -y -q libxml2-utils
      - name: Validate XML
        run: |
          errors=0
          while IFS= read -r -d '' f; do
            xmllint --noout "$f" 2>&1 || { echo "FAIL: $f"; errors=$((errors+1)); }
          done < <(find net/reticulum/src -name "*.xml" -print0)
          [ "$errors" -eq 0 ] || { echo "$errors file(s) failed XML validation"; exit 1; }
          echo "XML validation OK"

  shell:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: "./net/reticulum/src"
          severity: warning

  python:
    name: Python Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check Python syntax
        run: |
          errors=0
          while IFS= read -r -d '' f; do
            python3 -m py_compile "$f" 2>&1 || { echo "FAIL: $f"; errors=$((errors+1)); }
          done < <(find net/reticulum/src -name "*.py" -print0)
          [ "$errors" -eq 0 ] || { echo "$errors file(s) failed Python syntax check"; exit 1; }
          echo "Python syntax OK"
