#!/bin/sh

# OPNsense Reticulum Plugin — Post-Installation Script
# Sets up the service user, directories, permissions, and installs
# Reticulum (RNS) and LXMF from the bundled upstream source.

set -e

SERVICE_USER="_reticulum"
SERVICE_GROUP="_reticulum"

# Verify UID/GID 920 is not already claimed by another user/group
if id -u 920 >/dev/null 2>&1 && [ "$(pw usershow -u 920 -7 2>/dev/null | cut -d: -f1)" != "${SERVICE_USER}" ]; then
    echo "ERROR: UID 920 is already in use. Cannot create ${SERVICE_USER}."
    exit 1
fi

PYTHON="/usr/local/bin/python3.11"
RNS_SRC="/usr/local/lib/rns-src"
LXMF_SRC="/usr/local/lib/lxmf-src"

# ---------------------------------------------------------------------------
# 1. Verify submodules were populated before make install was run
# ---------------------------------------------------------------------------
for SRC in "${RNS_SRC}" "${LXMF_SRC}"; do
    if [ ! -f "${SRC}/setup.py" ] && [ ! -f "${SRC}/pyproject.toml" ]; then
        echo "ERROR: Source directory missing or empty: ${SRC}"
        echo "       The git submodules were not populated before 'make install'."
        echo "       Re-clone with:  git clone --recurse-submodules <repo>"
        echo "       Or run:         git submodule update --init --recursive"
        echo "       Then re-run:    make install && sh /usr/local/+POST_INSTALL"
        exit 1
    fi
done

# ---------------------------------------------------------------------------
# 3. Ensure pip is available (not bundled with Python on OPNsense/HardenedBSD)
# ---------------------------------------------------------------------------
if ! "${PYTHON}" -m pip --version > /dev/null 2>&1; then
    echo "pip not found — bootstrapping via ensurepip..."
    "${PYTHON}" -m ensurepip --upgrade
fi

# ---------------------------------------------------------------------------
# 4. Install Reticulum and LXMF from bundled source
# ---------------------------------------------------------------------------
# cryptography and pyserial are already satisfied by pkg (py311-cryptography,
# py311-serial), so we skip their installation here with --no-deps.
echo "Installing Reticulum from bundled source (${RNS_SRC})..."
"${PYTHON}" -m pip install --quiet --no-deps --upgrade "${RNS_SRC}"

echo "Installing LXMF from bundled source (${LXMF_SRC})..."
"${PYTHON}" -m pip install --quiet --no-deps --upgrade "${LXMF_SRC}"

# ---------------------------------------------------------------------------
# 5. Create dedicated service user and group
# ---------------------------------------------------------------------------
if ! pw groupshow "${SERVICE_GROUP}" > /dev/null 2>&1; then
    pw groupadd "${SERVICE_GROUP}" -g 920
    echo "Created group: ${SERVICE_GROUP}"
fi

if ! pw usershow "${SERVICE_USER}" > /dev/null 2>&1; then
    pw useradd "${SERVICE_USER}" \
        -u 920 \
        -g "${SERVICE_GROUP}" \
        -d /nonexistent \
        -s /usr/sbin/nologin \
        -c "Reticulum Network Daemon"
    echo "Created user: ${SERVICE_USER}"
fi

# Add service user to dialer group for serial device access (RNode, KISS, Serial)
pw groupmod dialer -m "${SERVICE_USER}" 2>/dev/null || true

# ---------------------------------------------------------------------------
# 6. Create runtime directories
# ---------------------------------------------------------------------------
mkdir -p /usr/local/etc/reticulum
mkdir -p /usr/local/etc/lxmd
mkdir -p /var/db/lxmd/messagestore
mkdir -p /var/log/reticulum

# Set ownership and permissions
chown -R "${SERVICE_USER}:${SERVICE_GROUP}" /usr/local/etc/reticulum
chown -R "${SERVICE_USER}:${SERVICE_GROUP}" /usr/local/etc/lxmd
chown -R "${SERVICE_USER}:${SERVICE_GROUP}" /var/db/lxmd
chown -R "${SERVICE_USER}:${SERVICE_GROUP}" /var/log/reticulum

chmod 750 /usr/local/etc/reticulum
chmod 750 /usr/local/etc/lxmd
chmod 750 /var/db/lxmd
chmod 750 /var/db/lxmd/messagestore
chmod 750 /var/log/reticulum

# ---------------------------------------------------------------------------
# 7. Make plugin scripts executable
# ---------------------------------------------------------------------------
chmod +x /usr/local/opnsense/scripts/OPNsense/Reticulum/setup.sh
chmod +x /usr/local/opnsense/scripts/OPNsense/Reticulum/status.py
chmod +x /usr/local/opnsense/scripts/OPNsense/Reticulum/diagnostics.py

# ---------------------------------------------------------------------------
# 8. Restart configd to pick up new action definitions
# ---------------------------------------------------------------------------
service configd restart

echo "Reticulum plugin post-installation complete."
echo "  Reticulum (RNS): $(${PYTHON} -c 'import RNS; print(RNS.__version__)' 2>/dev/null || echo unknown)"
echo "  LXMF:            $(${PYTHON} -c 'import LXMF; print(LXMF.__version__)' 2>/dev/null || echo unknown)"
