#!/bin/sh

# OPNsense Reticulum Plugin — Post-Installation Script
# Sets up the service user, directories, permissions, and installs
# Reticulum (RNS) from the bundled upstream source.

set -e

SERVICE_USER="_reticulum"
SERVICE_GROUP="_reticulum"

# Verify UID/GID 920 is not already claimed by another user/group
if id -u 920 >/dev/null 2>&1 && [ "$(pw usershow -u 920 -7 2>/dev/null | cut -d: -f1)" != "${SERVICE_USER}" ]; then
    echo "ERROR: UID 920 is already in use. Cannot create ${SERVICE_USER}."
    exit 1
fi

PYTHON="/usr/local/bin/python3.11"
RNS_SRC="/usr/local/lib/rns-src"

# ---------------------------------------------------------------------------
# 1. Verify submodule was populated before make install was run
# ---------------------------------------------------------------------------
if [ ! -f "${RNS_SRC}/setup.py" ] && [ ! -f "${RNS_SRC}/pyproject.toml" ]; then
    echo "ERROR: Source directory missing or empty: ${RNS_SRC}"
    echo "       The git submodule was not populated before 'make install'."
    echo "       Re-clone with:  git clone --recurse-submodules <repo>"
    echo "       Or run:         git submodule update --init --recursive"
    echo "       Then re-run:    make install && sh /usr/local/+POST_INSTALL"
    exit 1
fi

# ---------------------------------------------------------------------------
# 2. Ensure pip is available (not bundled with Python on OPNsense/HardenedBSD)
# ---------------------------------------------------------------------------
if ! "${PYTHON}" -m pip --version > /dev/null 2>&1; then
    echo "pip not found — bootstrapping via ensurepip..."
    "${PYTHON}" -m ensurepip --upgrade
fi

# ---------------------------------------------------------------------------
# 3. Install Reticulum (RNS) from bundled source
# ---------------------------------------------------------------------------
# py311-cryptography and py311-serial are satisfied by pkg; skip with --no-deps.
echo "Installing Reticulum (RNS) from bundled source (${RNS_SRC})..."
"${PYTHON}" -m pip install --quiet --no-deps --upgrade "${RNS_SRC}"

# ---------------------------------------------------------------------------
# 4. Create dedicated service user and group
# ---------------------------------------------------------------------------
if ! pw groupshow "${SERVICE_GROUP}" > /dev/null 2>&1; then
    pw groupadd "${SERVICE_GROUP}" -g 920
    echo "Created group: ${SERVICE_GROUP}"
fi

if ! pw usershow "${SERVICE_USER}" > /dev/null 2>&1; then
    pw useradd "${SERVICE_USER}" \
        -u 920 \
        -g "${SERVICE_GROUP}" \
        -d /nonexistent \
        -s /usr/sbin/nologin \
        -c "Reticulum Network Daemon"
    echo "Created user: ${SERVICE_USER}"
fi

# Add service user to dialer group for serial device access (RNode, KISS, Serial)
pw groupmod dialer -m "${SERVICE_USER}" 2>/dev/null || true

# ---------------------------------------------------------------------------
# 5. Create runtime directories
# ---------------------------------------------------------------------------
mkdir -p /usr/local/etc/reticulum
mkdir -p /var/log/reticulum

# Set ownership and permissions
chown -R "${SERVICE_USER}:${SERVICE_GROUP}" /usr/local/etc/reticulum
chown -R "${SERVICE_USER}:${SERVICE_GROUP}" /var/log/reticulum

chmod 750 /usr/local/etc/reticulum
chmod 750 /var/log/reticulum

# ---------------------------------------------------------------------------
# 6. Make plugin scripts executable
# ---------------------------------------------------------------------------
chmod +x /usr/local/opnsense/scripts/OPNsense/Reticulum/setup.sh
chmod +x /usr/local/opnsense/scripts/OPNsense/Reticulum/status.py
chmod +x /usr/local/opnsense/scripts/OPNsense/Reticulum/diagnostics.py
chmod +x /usr/local/opnsense/scripts/OPNsense/Reticulum/utilities.py

# ---------------------------------------------------------------------------
# 7. Restart configd to pick up new action definitions
# ---------------------------------------------------------------------------
service configd restart

echo "Reticulum plugin post-installation complete."
echo "  Reticulum (RNS): $(${PYTHON} -c 'import RNS; print(RNS.__version__)' 2>/dev/null || echo unknown)"
